<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AiSyster Admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --text-primary: #1a1a2e;
      --text-secondary: #6b7280;
      --border: #e5e7eb;
      --gold: #b8860b;
      --gold-light: #daa520;
      --green: #10b981;
      --red: #ef4444;
      --blue: #3b82f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      margin-bottom: 24px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: white;
    }

    .logo h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .logo span {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 400;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--gold);
      color: white;
    }

    .btn-primary:hover {
      background: var(--gold-light);
    }

    .btn-secondary {
      background: white;
      border: 1px solid var(--border);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-change {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive {
      color: var(--green);
    }

    .stat-change.negative {
      color: var(--red);
    }

    /* Main Content */
    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      font-size: 16px;
      font-weight: 600;
    }

    .card-body {
      padding: 0;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      background: var(--bg-secondary);
    }

    td {
      font-size: 14px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: var(--bg-secondary);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-premium {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-free {
      background: #e5e7eb;
      color: #374151;
    }

    .badge-active {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Activity List */
    .activity-list {
      padding: 0;
    }

    .activity-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .activity-icon.login {
      background: #dbeafe;
      color: var(--blue);
    }

    .activity-icon.message {
      background: #d1fae5;
      color: var(--green);
    }

    .activity-icon.register {
      background: #fef3c7;
      color: var(--gold);
    }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 14px;
      color: var(--text-primary);
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Search */
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding: 0 16px;
    }

    .search-box input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--gold);
    }

    /* Actions */
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .action-btn.premium {
      background: #fef3c7;
      color: #92400e;
    }

    .action-btn.premium:hover {
      background: #fcd34d;
    }

    .action-btn.danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .action-btn.danger:hover {
      background: #fecaca;
    }

    .action-btn.secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .action-btn.secondary:hover {
      background: #d1d5db;
    }

    .actions-dropdown {
      position: relative;
      display: inline-block;
    }

    .actions-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 160px;
      z-index: 100;
    }

    .actions-menu.show {
      display: block;
    }

    .actions-menu button {
      display: block;
      width: 100%;
      padding: 10px 14px;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .actions-menu button:hover {
      background: var(--bg-secondary);
    }

    .actions-menu button.danger {
      color: var(--red);
    }

    .logo-img {
      height: 40px;
      width: auto;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
    }

    .modal h3 {
      margin-bottom: 12px;
    }

    .modal p {
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Login Form */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      text-align: center;
    }

    .login-container h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .login-container p {
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-wrapper input {
      padding-right: 44px;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      transition: color 0.2s;
    }

    .password-toggle:hover {
      color: #6b7280;
    }

    .password-toggle svg {
      width: 20px;
      height: 20px;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--gold);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .login-btn:hover {
      background: var(--gold-light);
    }

    .error-msg {
      color: var(--red);
      font-size: 14px;
      margin-top: 12px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    /* Loading States */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-spinner-small {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .is-loading {
      pointer-events: none;
    }

    /* Refresh Indicator */
    .refresh-indicator {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-indicator button {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
    }

    .refresh-indicator button:hover {
      background: var(--bg-secondary);
    }

    /* Stat value transition */
    .stat-value {
      transition: opacity 0.2s ease;
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginScreen" class="container">
    <div class="login-container">
      <img src="/static/icons/logo-admin.png" alt="AiSyster" style="height: 80px; margin-bottom: 16px;">
      <h1>Admin</h1>
      <p>Painel de administracao</p>

      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="admin@aisyster.com" required>
        </div>
        <div class="form-group">
          <label>Senha</label>
          <div class="password-wrapper">
            <input type="password" id="loginPassword" placeholder="Sua senha" required>
            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)" aria-label="Mostrar senha">
              <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
        </div>
        <button type="submit" class="login-btn">Entrar</button>
        <div id="loginError" class="error-msg" style="display: none;"></div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmacao -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal">
      <h3 id="modalTitle">Confirmar acao</h3>
      <p id="modalMessage">Tem certeza que deseja realizar esta acao?</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" id="modalConfirmBtn" onclick="confirmModalAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="container" style="display: none;">
    <header>
      <div class="logo">
        <img src="/static/icons/icon-512x512.png" alt="AiSyster" class="logo-img">
        <div>
          <h1>AiSyster <span>Admin</span></h1>
        </div>
      </div>
      <div class="header-actions">
        <div class="refresh-indicator">
          <span id="refreshIndicator"></span>
          <button onclick="toggleAutoRefresh()">Toggle</button>
        </div>
        <button class="btn btn-secondary" onclick="refreshData()">Atualizar</button>
        <button class="btn btn-secondary" onclick="logout()">Sair</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total de Usuarios</div>
        <div class="stat-value" id="statTotalUsers">-</div>
        <div class="stat-change positive" id="statNewUsers">+0 esta semana</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Usuarios Premium</div>
        <div class="stat-value" id="statPremiumUsers">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ativos Hoje</div>
        <div class="stat-value" id="statActiveToday">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Conversas Hoje</div>
        <div class="stat-value" id="statConversationsToday">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total de Mensagens</div>
        <div class="stat-value" id="statTotalMessages">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Media por Conversa</div>
        <div class="stat-value" id="statAvgMessages">-</div>
      </div>
    </div>

    <!-- Tabs -->
    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
      <button class="btn btn-primary" id="tabUsers" onclick="showTab('users')" style="opacity: 1;">Usu√°rios</button>
      <button class="btn btn-secondary" id="tabFinancial" onclick="showTab('financial')">üí∞ Financeiro</button>
      <button class="btn btn-secondary" id="tabFeedbacks" onclick="showTab('feedbacks')">Feedbacks <span id="feedbackBadge" style="background: var(--red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 4px; display: none;">0</span></button>
      <button class="btn btn-secondary" id="tabNotifications" onclick="showTab('notifications')">Notifica√ß√µes</button>
      <button class="btn btn-secondary" id="tabBackup" onclick="showTab('backup')">Backup</button>
    </div>

    <!-- Users Tab -->
    <div id="usersTab" class="main-grid">
      <!-- Users Table -->
      <div class="card">
        <div class="card-header">
          <h2>Usuarios</h2>
          <input type="text" id="userSearch" placeholder="Buscar por email..." style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;" onkeyup="searchUsers()">
        </div>
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Plano</th>
                <th>Mensagens</th>
                <th>Ultimo Login</th>
                <th>Acoes</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr><td colspan="5" class="loading">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Activity -->
      <div class="card">
        <div class="card-header">
          <h2>Atividade Recente</h2>
        </div>
        <div class="card-body activity-list" id="activityList">
          <div class="loading">Carregando...</div>
        </div>
      </div>
    </div>

    <!-- Financial Tab -->
    <div id="financialTab" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">An√°lise Financeira</h3>
        <button class="btn btn-secondary" onclick="loadFinancialStats()">üîÑ Atualizar</button>
      </div>

      <!-- Summary Cards -->
      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-card" style="border-left: 4px solid var(--gold);">
          <div class="stat-label">Receita Mensal</div>
          <div class="stat-value" id="finRevenue" style="color: var(--green);">-</div>
          <div class="stat-change" id="finPremiumCount">0 assinantes</div>
        </div>
        <div class="stat-card" style="border-left: 4px solid #ef4444;">
          <div class="stat-label">Custo AI (M√™s)</div>
          <div class="stat-value" id="finCost" style="color: #ef4444;">-</div>
          <div class="stat-change" id="finTotalCost">Total: $0.00</div>
        </div>
        <div class="stat-card" style="border-left: 4px solid var(--green);">
          <div class="stat-label">Lucro Estimado</div>
          <div class="stat-value" id="finProfit">-</div>
          <div class="stat-change" id="finMargin">Margem: 0%</div>
        </div>
        <div class="stat-card" style="border-left: 4px solid #3b82f6;">
          <div class="stat-label">Custo/Usu√°rio Ativo</div>
          <div class="stat-value" id="finCostPerUser">-</div>
          <div class="stat-change" id="finActiveUsers">0 ativos (30d)</div>
        </div>
      </div>

      <!-- Detailed Stats -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- Users Section -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">üë• Usu√°rios</span>
          </div>
          <div class="card-body" style="padding: 16px;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Total de usu√°rios</td>
                <td style="padding: 8px 0; text-align: right; font-weight: bold;" id="finTotalUsers">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Premium</td>
                <td style="padding: 8px 0; text-align: right; font-weight: bold; color: var(--gold);" id="finPremiumUsers">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Gratuitos</td>
                <td style="padding: 8px 0; text-align: right;" id="finFreeUsers">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Taxa de Convers√£o</td>
                <td style="padding: 8px 0; text-align: right; color: var(--green);" id="finConversion">-</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">Reten√ß√£o (30 dias)</td>
                <td style="padding: 8px 0; text-align: right;" id="finRetention">-</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Messages Section -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">üí¨ Mensagens</span>
          </div>
          <div class="card-body" style="padding: 16px;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Total de mensagens</td>
                <td style="padding: 8px 0; text-align: right; font-weight: bold;" id="finTotalMessages">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Este m√™s</td>
                <td style="padding: 8px 0; text-align: right;" id="finMessagesMonth">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">De Premium</td>
                <td style="padding: 8px 0; text-align: right; color: var(--gold);" id="finPremiumMsgs">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">De Gratuitos</td>
                <td style="padding: 8px 0; text-align: right;" id="finFreeMsgs">-</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">M√©dia por usu√°rio</td>
                <td style="padding: 8px 0; text-align: right;" id="finAvgMsgs">-</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Costs Section -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">üí∏ Custos Detalhados</span>
          </div>
          <div class="card-body" style="padding: 16px;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Custo total AI</td>
                <td style="padding: 8px 0; text-align: right; font-weight: bold; color: #ef4444;" id="finTotalAICost">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Custo/msg Premium</td>
                <td style="padding: 8px 0; text-align: right;" id="finCostPremiumMsg">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Custo/msg Gratuito</td>
                <td style="padding: 8px 0; text-align: right;" id="finCostFreeMsg">-</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">Custo/usu√°rio ativo</td>
                <td style="padding: 8px 0; text-align: right;" id="finCostPerActiveUser">-</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Activity Section -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìä Atividade</span>
          </div>
          <div class="card-body" style="padding: 16px;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Ativos (7 dias)</td>
                <td style="padding: 8px 0; text-align: right; font-weight: bold;" id="finActive7d">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Ativos (30 dias)</td>
                <td style="padding: 8px 0; text-align: right;" id="finActive30d">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Novos este m√™s</td>
                <td style="padding: 8px 0; text-align: right; color: var(--green);" id="finNewMonth">-</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 8px 0;">Total conversas</td>
                <td style="padding: 8px 0; text-align: right;" id="finTotalConvs">-</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">Conversas (m√™s)</td>
                <td style="padding: 8px 0; text-align: right;" id="finConvsMonth">-</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <!-- Engagement -->
      <div class="card" style="margin-top: 20px;">
        <div class="card-header">
          <span class="card-title">üéØ Indicadores de Sa√∫de</span>
        </div>
        <div class="card-body" style="padding: 16px;">
          <div style="display: flex; gap: 40px; flex-wrap: wrap;">
            <div>
              <div style="color: var(--text-secondary); font-size: 13px;">Engajamento Premium</div>
              <div style="font-size: 20px; font-weight: bold; color: var(--gold);" id="finEngagePremium">-</div>
            </div>
            <div>
              <div style="color: var(--text-secondary); font-size: 13px;">Engajamento Gratuito</div>
              <div style="font-size: 20px; font-weight: bold;" id="finEngageFree">-</div>
            </div>
            <div>
              <div style="color: var(--text-secondary); font-size: 13px;">M√©dia msgs/usu√°rio</div>
              <div style="font-size: 20px; font-weight: bold;" id="finAvgMsgsUser">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedbacks Tab -->
    <div id="feedbacksTab" style="display: none;">
      <!-- Feedback Stats -->
      <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card">
          <div class="stat-label">Total de Feedbacks</div>
          <div class="stat-value" id="statTotalFeedbacks">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pendentes</div>
          <div class="stat-value" id="statPendingFeedbacks" style="color: var(--red);">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Revisados</div>
          <div class="stat-value" id="statReviewedFeedbacks" style="color: #10b981;">-</div>
        </div>
      </div>

      <!-- Feedbacks List -->
      <div class="card">
        <div class="card-header">
          <h2>Feedbacks Reportados</h2>
          <select id="feedbackFilter" onchange="loadFeedbacks()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
            <option value="">Todos</option>
            <option value="pending">Pendentes</option>
            <option value="reviewed">Revisados</option>
          </select>
        </div>
        <div class="card-body">
          <div id="feedbacksList">
            <div class="loading">Carregando...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Backup Tab -->
    <div id="backupTab" style="display: none;">
      <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card">
          <div class="stat-label">Usu√°rios</div>
          <div class="stat-value" id="backupUsers">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Conversas</div>
          <div class="stat-value" id="backupConversations">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Mensagens</div>
          <div class="stat-value" id="backupMessages">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Mem√≥rias</div>
          <div class="stat-value" id="backupMemories">-</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Backup do Banco de Dados</h2>
        </div>
        <div class="card-body" style="padding: 24px;">
          <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <strong style="color: #92400e;">‚ö†Ô∏è Importante:</strong>
            <p style="color: #92400e; margin-top: 8px; font-size: 14px;">
              O backup inclui todos os dados do sistema. As mensagens permanecem criptografadas por seguran√ßa.
              Recomendamos fazer backup semanalmente e salvar em local seguro (Google Drive, Dropbox, etc).
            </p>
          </div>

          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="downloadBackup()" style="padding: 12px 24px; font-size: 16px;">
              üì• Baixar Backup Completo
            </button>
            <button class="btn btn-secondary" onclick="loadBackupStats()" style="padding: 12px 24px;">
              üîÑ Atualizar Estat√≠sticas
            </button>
          </div>

          <div id="backupStatus" style="margin-top: 16px; display: none;">
            <div class="loading">Gerando backup...</div>
          </div>

          <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
            <h3 style="font-size: 16px; margin-bottom: 12px;">O que est√° inclu√≠do no backup:</h3>
            <ul style="color: var(--text-secondary); font-size: 14px; line-height: 1.8; padding-left: 20px;">
              <li>Dados de usu√°rios (sem senhas)</li>
              <li>Perfis e prefer√™ncias</li>
              <li>Todas as conversas</li>
              <li>Mensagens (criptografadas)</li>
              <li>Mem√≥rias salvas</li>
              <li>Perfis psicol√≥gicos</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Tab -->
    <div id="notificationsTab" style="display: none;">
      <!-- Notification Stats -->
      <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card">
          <div class="stat-label">Total Enviadas</div>
          <div class="stat-value" id="statTotalNotifications">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Entregas com Sucesso</div>
          <div class="stat-value" id="statDeliveries" style="color: var(--green);">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Push Registrado</div>
          <div class="stat-value" id="statPushRegistered" style="color: var(--primary);">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Email Habilitado</div>
          <div class="stat-value" id="statEmailEnabled">-</div>
        </div>
      </div>

      <!-- Send Notification Form -->
      <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
          <h2>Enviar Nova Notifica√ß√£o</h2>
        </div>
        <div class="card-body" style="padding: 24px;">
          <div style="display: grid; gap: 16px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">T√≠tulo *</label>
              <input type="text" id="notifTitle" placeholder="Ex: Feliz Ano Novo!" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">Mensagem *</label>
              <textarea id="notifMessage" placeholder="Ex: Que este novo ano seja repleto de b√™n√ß√£os e conquistas!" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Envio</label>
                <div style="display: flex; gap: 16px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="sendPush" checked style="width: 18px; height: 18px;">
                    Push
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="sendEmail" checked style="width: 18px; height: 18px;">
                    Email
                  </label>
                </div>
              </div>

              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Destinat√°rios</label>
                <select id="targetAudience" onchange="updateRecipientPreview()" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                  <option value="all">Todos os Usu√°rios</option>
                  <option value="premium">Apenas Premium</option>
                  <option value="free">Apenas Gratuitos</option>
                </select>
              </div>
            </div>

            <div id="recipientPreview" style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 20px;">üë•</span>
              <div style="flex: 1;">
                <div style="font-weight: 500; color: #0369a1; margin-bottom: 4px;">Quem vai receber:</div>
                <div style="font-size: 14px; color: #0369a1;" id="previewText">Calculando...</div>
              </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 8px;">
              <button class="btn btn-secondary" onclick="clearNotificationForm()">Limpar</button>
              <button class="btn btn-primary" onclick="sendNotification()" style="padding: 12px 24px;">
                üì§ Enviar Notifica√ß√£o
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Notification History -->
      <div class="card">
        <div class="card-header">
          <h2>Hist√≥rico de Envios</h2>
          <button class="btn btn-secondary" onclick="loadNotificationHistory()" style="padding: 8px 16px;">üîÑ Atualizar</button>
        </div>
        <div class="card-body">
          <div id="notificationHistory">
            <div class="loading">Carregando...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes do Feedback -->
  <div id="feedbackDetailModal" class="modal-overlay">
    <div class="modal" style="max-width: 600px;">
      <h3>Detalhes do Feedback</h3>
      <div id="feedbackDetailContent" style="margin: 16px 0;">
        <!-- Conte√∫do preenchido via JS -->
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeFeedbackDetail()">Fechar</button>
        <button class="btn btn-primary" id="markReviewedBtn" onclick="markFeedbackReviewed()">Marcar como Revisado</button>
      </div>
    </div>
  </div>

  <script>
    // Migration: soulhaven_admin_token -> aisyster_admin_token
    (function() {
      const oldToken = localStorage.getItem('soulhaven_admin_token');
      if (oldToken && !localStorage.getItem('aisyster_admin_token')) {
        localStorage.setItem('aisyster_admin_token', oldToken);
        localStorage.removeItem('soulhaven_admin_token');
      }
    })();

    const API_URL = window.location.origin;
    let token = localStorage.getItem('aisyster_admin_token');

    // ============================================
    // AUTO-REFRESH POLLING SYSTEM
    // ============================================
    let autoRefreshInterval = null;
    let autoRefreshEnabled = true;
    const AUTO_REFRESH_INTERVAL = 30000; // 30 segundos
    let lastUpdate = null;

    function startAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = setInterval(() => {
        if (autoRefreshEnabled && document.visibilityState === 'visible') {
          silentRefresh();
        }
      }, AUTO_REFRESH_INTERVAL);
      updateRefreshIndicator();
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      updateRefreshIndicator();
      if (autoRefreshEnabled) {
        startAutoRefresh();
      }
    }

    function updateRefreshIndicator() {
      const indicator = document.getElementById('refreshIndicator');
      if (indicator) {
        indicator.innerHTML = autoRefreshEnabled
          ? `<span style="color: var(--green);">‚óè Auto-refresh ON</span> ${lastUpdate ? `(${formatTimeAgo(lastUpdate)})` : ''}`
          : '<span style="color: var(--text-secondary);">‚óã Auto-refresh OFF</span>';
      }
    }

    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'agora';
      const minutes = Math.floor(seconds / 60);
      return `${minutes}m atr√°s`;
    }

    async function silentRefresh() {
      // Refresh sem loading states vis√≠veis
      try {
        await Promise.all([
          loadUserStats(true),
          loadConversationStats(true),
          loadActivity(true)
        ]);
        lastUpdate = new Date();
        updateRefreshIndicator();
      } catch (error) {
        console.error('Silent refresh error:', error);
      }
    }

    // Pause refresh when tab is hidden
    document.addEventListener('visibilitychange', () => {
      updateRefreshIndicator();
    });

    // Check auth on load
    if (token) {
      showDashboard();
      loadData();
      startAutoRefresh();
    }

    // Toggle password visibility
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const eyeOpen = button.querySelector('.eye-open');
      const eyeClosed = button.querySelector('.eye-closed');

      if (input.type === 'password') {
        input.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
        button.setAttribute('aria-label', 'Ocultar senha');
      } else {
        input.type = 'password';
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
        button.setAttribute('aria-label', 'Mostrar senha');
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!response.ok) {
          throw new Error('Credenciais invalidas');
        }

        const data = await response.json();
        token = data.access_token;
        localStorage.setItem('aisyster_admin_token', token);

        // Verify admin access
        const testResponse = await fetch(`${API_URL}/admin/stats/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (testResponse.status === 403) {
          throw new Error('Acesso negado. Voce nao e administrador.');
        }

        showDashboard();
        loadData();
      } catch (error) {
        document.getElementById('loginError').textContent = error.message;
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
    }

    function logout() {
      stopAutoRefresh();
      token = null;
      localStorage.removeItem('aisyster_admin_token');
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('dashboard').style.display = 'none';
    }

    // ============================================
    // LOADING STATES
    // ============================================
    function showLoading(elementId, small = false) {
      const el = document.getElementById(elementId);
      if (el) {
        el.dataset.originalContent = el.innerHTML;
        el.innerHTML = small
          ? '<span class="loading-spinner-small"></span>'
          : '<div class="loading-state"><span class="loading-spinner"></span> Carregando...</div>';
        el.classList.add('is-loading');
      }
    }

    function hideLoading(elementId) {
      const el = document.getElementById(elementId);
      if (el && el.classList.contains('is-loading')) {
        el.classList.remove('is-loading');
      }
    }

    function setStatLoading(elementId) {
      const el = document.getElementById(elementId);
      if (el && !el.dataset.loading) {
        el.dataset.loading = 'true';
        el.style.opacity = '0.5';
      }
    }

    function clearStatLoading(elementId) {
      const el = document.getElementById(elementId);
      if (el) {
        el.dataset.loading = '';
        el.style.opacity = '1';
      }
    }

    async function loadData() {
      await Promise.all([
        loadUserStats(),
        loadConversationStats(),
        loadUsers(),
        loadActivity(),
        loadFeedbackStats()
      ]);
    }

    async function refreshData() {
      await loadData();
      if (document.getElementById('feedbacksTab').style.display !== 'none') {
        loadFeedbacks();
      }
    }

    // Tab switching
    function showTab(tab) {
      // Hide all tabs
      document.getElementById('usersTab').style.display = 'none';
      document.getElementById('financialTab').style.display = 'none';
      document.getElementById('feedbacksTab').style.display = 'none';
      document.getElementById('notificationsTab').style.display = 'none';
      document.getElementById('backupTab').style.display = 'none';

      // Reset all buttons
      document.getElementById('tabUsers').className = 'btn btn-secondary';
      document.getElementById('tabFinancial').className = 'btn btn-secondary';
      document.getElementById('tabFeedbacks').className = 'btn btn-secondary';
      document.getElementById('tabNotifications').className = 'btn btn-secondary';
      document.getElementById('tabBackup').className = 'btn btn-secondary';

      // Show selected tab
      if (tab === 'users') {
        document.getElementById('usersTab').style.display = 'grid';
        document.getElementById('tabUsers').className = 'btn btn-primary';
      } else if (tab === 'financial') {
        document.getElementById('financialTab').style.display = 'block';
        document.getElementById('tabFinancial').className = 'btn btn-primary';
        loadFinancialStats();
      } else if (tab === 'feedbacks') {
        document.getElementById('feedbacksTab').style.display = 'block';
        document.getElementById('tabFeedbacks').className = 'btn btn-primary';
        loadFeedbacks();
      } else if (tab === 'notifications') {
        document.getElementById('notificationsTab').style.display = 'block';
        document.getElementById('tabNotifications').className = 'btn btn-primary';
        loadNotificationStats();
        loadNotificationHistory();
        updateRecipientPreview();
      } else if (tab === 'backup') {
        document.getElementById('backupTab').style.display = 'block';
        document.getElementById('tabBackup').className = 'btn btn-primary';
        loadBackupStats();
      }
    }

    async function loadFinancialStats() {
      try {
        const response = await fetch(`${API_URL}/admin/stats/financial`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load');

        const data = await response.json();

        // Summary cards
        document.getElementById('finRevenue').textContent = data.revenue.monthly_revenue_usd;
        document.getElementById('finPremiumCount').textContent = `${data.summary.premium_users} assinantes`;
        document.getElementById('finCost').textContent = data.costs.monthly_ai_cost_usd;
        document.getElementById('finTotalCost').textContent = `Total: ${data.costs.total_ai_cost_usd}`;
        document.getElementById('finProfit').textContent = data.revenue.monthly_profit_usd;
        document.getElementById('finMargin').textContent = `Margem: ${data.revenue.profit_margin}`;
        document.getElementById('finCostPerUser').textContent = data.costs.cost_per_active_user;
        document.getElementById('finActiveUsers').textContent = `${data.activity.active_30_days} ativos (30d)`;

        // Users section
        document.getElementById('finTotalUsers').textContent = data.summary.total_users;
        document.getElementById('finPremiumUsers').textContent = data.summary.premium_users;
        document.getElementById('finFreeUsers').textContent = data.summary.free_users;
        document.getElementById('finConversion').textContent = data.summary.conversion_rate;
        document.getElementById('finRetention').textContent = data.summary.retention_30d;

        // Messages section
        document.getElementById('finTotalMessages').textContent = data.messages.total.toLocaleString();
        document.getElementById('finMessagesMonth').textContent = data.messages.this_month.toLocaleString();
        document.getElementById('finPremiumMsgs').textContent = data.messages.from_premium_users.toLocaleString();
        document.getElementById('finFreeMsgs').textContent = data.messages.from_free_users.toLocaleString();
        document.getElementById('finAvgMsgs').textContent = data.messages.avg_per_active_user;

        // Costs section
        document.getElementById('finTotalAICost').textContent = data.costs.total_ai_cost_usd;
        document.getElementById('finCostPremiumMsg').textContent = data.costs.cost_per_premium_msg;
        document.getElementById('finCostFreeMsg').textContent = data.costs.cost_per_free_msg;
        document.getElementById('finCostPerActiveUser').textContent = data.costs.cost_per_active_user;

        // Activity section
        document.getElementById('finActive7d').textContent = data.activity.active_7_days;
        document.getElementById('finActive30d').textContent = data.activity.active_30_days;
        document.getElementById('finNewMonth').textContent = data.activity.new_this_month;
        document.getElementById('finTotalConvs').textContent = data.activity.total_conversations;
        document.getElementById('finConvsMonth').textContent = data.activity.conversations_this_month;

        // Health indicators
        document.getElementById('finEngagePremium').textContent = data.health_indicators.premium_engagement;
        document.getElementById('finEngageFree').textContent = data.health_indicators.free_engagement;
        document.getElementById('finAvgMsgsUser').textContent = data.health_indicators.avg_messages_per_user;

      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas financeiras:', error);
      }
    }

    async function loadBackupStats() {
      try {
        const response = await fetch(`${API_URL}/admin/backup/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('backupUsers').textContent = data.users;
          document.getElementById('backupConversations').textContent = data.conversations;
          document.getElementById('backupMessages').textContent = data.messages;
          document.getElementById('backupMemories').textContent = data.memories;
        }
      } catch (error) {
        console.error('Erro ao carregar stats de backup:', error);
      }
    }

    async function downloadBackup() {
      const statusDiv = document.getElementById('backupStatus');
      statusDiv.style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/admin/backup/full`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `aisyster_backup_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
          statusDiv.innerHTML = '<div style="color: #10b981;">‚úÖ Backup baixado com sucesso!</div>';
        } else {
          statusDiv.innerHTML = '<div style="color: #ef4444;">‚ùå Erro ao gerar backup</div>';
        }
      } catch (error) {
        console.error('Erro ao baixar backup:', error);
        statusDiv.innerHTML = '<div style="color: #ef4444;">‚ùå Erro ao gerar backup</div>';
      }

      setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
    }

    async function loadUserStats(silent = false) {
      const statIds = ['statTotalUsers', 'statPremiumUsers', 'statActiveToday'];

      if (!silent) {
        statIds.forEach(id => setStatLoading(id));
      }

      try {
        const response = await fetch(`${API_URL}/admin/stats/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 403) {
          logout();
          return;
        }

        const data = await response.json();
        document.getElementById('statTotalUsers').textContent = data.total_users;
        document.getElementById('statPremiumUsers').textContent = data.premium_users;
        document.getElementById('statActiveToday').textContent = data.active_today;
        document.getElementById('statNewUsers').textContent = `+${data.new_this_week} esta semana`;
      } catch (error) {
        console.error('Error loading user stats:', error);
      } finally {
        statIds.forEach(id => clearStatLoading(id));
      }
    }

    async function loadConversationStats(silent = false) {
      const statIds = ['statConversationsToday', 'statTotalMessages'];

      if (!silent) {
        statIds.forEach(id => setStatLoading(id));
      }

      try {
        const response = await fetch(`${API_URL}/admin/stats/conversations`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();
        document.getElementById('statConversationsToday').textContent = data.conversations_today;
        document.getElementById('statTotalMessages').textContent = data.total_messages.toLocaleString();
        document.getElementById('statAvgMessages').textContent = data.avg_messages_per_conversation;
      } catch (error) {
        console.error('Error loading conversation stats:', error);
      } finally {
        statIds.forEach(id => clearStatLoading(id));
      }
    }

    async function loadUsers(search = '') {
      try {
        const url = search
          ? `${API_URL}/admin/users?search=${encodeURIComponent(search)}`
          : `${API_URL}/admin/users`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const users = await response.json();

        const tbody = document.getElementById('usersTableBody');

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">Nenhum usuario encontrado</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(user => `
          <tr>
            <td>
              <div><strong>${user.nome || user.email.split('@')[0]}</strong></div>
              <div style="font-size: 12px; color: var(--text-secondary);">${user.email}</div>
              ${user.is_active === false ? '<span class="badge badge-inactive" style="margin-top: 4px;">Desativado</span>' : ''}
            </td>
            <td>
              <span class="badge ${user.is_premium ? 'badge-premium' : 'badge-free'}">
                ${user.is_premium ? 'Premium' : 'Gratuito'}
              </span>
            </td>
            <td>${user.total_messages}</td>
            <td style="font-size: 12px; color: var(--text-secondary);">
              ${user.last_login ? new Date(user.last_login).toLocaleDateString('pt-BR') : 'Nunca'}
            </td>
            <td>
              <div class="actions-dropdown">
                <button class="action-btn secondary" onclick="toggleActionsMenu('${user.id}')">Acoes ‚ñæ</button>
                <div id="menu-${user.id}" class="actions-menu">
                  <button onclick="togglePremium('${user.id}', ${!user.is_premium}); closeAllMenus();">
                    ${user.is_premium ? '‚≠ê Remover Premium' : '‚≠ê Dar Premium'}
                  </button>
                  <button onclick="toggleUserActive('${user.id}', ${user.is_active !== false}); closeAllMenus();">
                    ${user.is_active === false ? '‚úì Ativar Conta' : '‚úó Desativar Conta'}
                  </button>
                  <button onclick="resetUserPassword('${user.id}', '${user.email}'); closeAllMenus();">
                    üîë Resetar Senha
                  </button>
                  <button class="danger" onclick="confirmDeleteUser('${user.id}', '${user.email}'); closeAllMenus();">
                    üóëÔ∏è Remover Usuario
                  </button>
                </div>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function loadActivity(silent = false) {
      const container = document.getElementById('activityList');

      if (!silent && container) {
        container.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span> Carregando...</div>';
      }

      try {
        const response = await fetch(`${API_URL}/admin/audit/recent?limit=20`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const logs = await response.json();

        if (logs.length === 0) {
          container.innerHTML = '<div class="loading">Nenhuma atividade recente</div>';
          return;
        }

        container.innerHTML = logs.map(log => {
          let iconClass = 'login';
          let icon = 'üë§';

          if (log.action === 'message_sent') {
            iconClass = 'message';
            icon = 'üí¨';
          } else if (log.action === 'register') {
            iconClass = 'register';
            icon = '‚ú®';
          } else if (log.action === 'oauth_login') {
            icon = 'üîê';
          }

          const time = new Date(log.created_at);
          const timeStr = time.toLocaleString('pt-BR');

          return `
            <div class="activity-item">
              <div class="activity-icon ${iconClass}">${icon}</div>
              <div class="activity-content">
                <div class="activity-text"><strong>${log.user_email || 'Usuario'}</strong> - ${log.action.replace('_', ' ')}</div>
                <div class="activity-time">${timeStr}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading activity:', error);
        if (!silent && container) {
          container.innerHTML = '<div style="color: var(--red); padding: 20px; text-align: center;">Erro ao carregar atividade</div>';
        }
      }
    }

    function searchUsers() {
      const search = document.getElementById('userSearch').value;
      loadUsers(search);
    }

    async function togglePremium(userId, isPremium) {
      try {
        const response = await fetch(`${API_URL}/admin/users/${userId}/premium?is_premium=${isPremium}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          loadUsers();
          loadUserStats();
        }
      } catch (error) {
        console.error('Error toggling premium:', error);
      }
    }

    // Menu dropdown
    function toggleActionsMenu(userId) {
      closeAllMenus();
      const menu = document.getElementById(`menu-${userId}`);
      if (menu) menu.classList.toggle('show');
    }

    function closeAllMenus() {
      document.querySelectorAll('.actions-menu').forEach(m => m.classList.remove('show'));
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.actions-dropdown')) {
        closeAllMenus();
      }
    });

    // Modal
    let pendingAction = null;

    function showModal(title, message, action, isDanger = false) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      const btn = document.getElementById('modalConfirmBtn');
      btn.className = isDanger ? 'btn btn-primary' : 'btn btn-primary';
      btn.style.background = isDanger ? 'var(--red)' : 'var(--gold)';
      pendingAction = action;
      document.getElementById('confirmModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('confirmModal').classList.remove('show');
      pendingAction = null;
    }

    function confirmModalAction() {
      if (pendingAction) {
        pendingAction();
      }
      closeModal();
    }

    // Desativar/Ativar usuario
    async function toggleUserActive(userId, isCurrentlyActive) {
      const action = isCurrentlyActive ? 'desativar' : 'ativar';
      showModal(
        `${isCurrentlyActive ? 'Desativar' : 'Ativar'} Usuario`,
        `Tem certeza que deseja ${action} este usuario?`,
        async () => {
          try {
            const response = await fetch(`${API_URL}/admin/users/${userId}/active?is_active=${!isCurrentlyActive}`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              loadUsers();
              alert(`Usuario ${action === 'desativar' ? 'desativado' : 'ativado'} com sucesso!`);
            } else {
              alert('Erro ao atualizar usuario');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Erro ao atualizar usuario');
          }
        },
        isCurrentlyActive
      );
    }

    // Resetar senha
    async function resetUserPassword(userId, email) {
      showModal(
        'Resetar Senha',
        `Enviar email de reset de senha para ${email}?`,
        async () => {
          try {
            const response = await fetch(`${API_URL}/admin/users/${userId}/reset-password`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              alert('Email de reset enviado com sucesso!');
            } else {
              alert('Erro ao enviar email de reset');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Erro ao enviar email de reset');
          }
        }
      );
    }

    // Ver conversas do usuario
    function viewUserConversations(userId, email) {
      alert(`Funcionalidade em desenvolvimento.\n\nUsuario: ${email}\nID: ${userId}`);
      // TODO: Implementar visualizacao de conversas
    }

    // Confirmar exclusao
    function confirmDeleteUser(userId, email) {
      showModal(
        'Remover Usuario',
        `ATENCAO: Esta acao e irreversivel! Todos os dados de ${email} serao removidos permanentemente. Deseja continuar?`,
        async () => {
          try {
            const response = await fetch(`${API_URL}/admin/users/${userId}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              loadUsers();
              loadUserStats();
              alert('Usuario removido com sucesso!');
            } else {
              const data = await response.json();
              alert(data.detail || 'Erro ao remover usuario');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Erro ao remover usuario');
          }
        },
        true
      );
    }

    // ============================================
    // FEEDBACKS
    // ============================================
    let currentFeedbackId = null;
    let feedbacksData = [];

    async function loadFeedbackStats() {
      try {
        const response = await fetch(`${API_URL}/admin/feedbacks/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const data = await response.json();
        document.getElementById('statTotalFeedbacks').textContent = data.total;
        document.getElementById('statPendingFeedbacks').textContent = data.pending;
        document.getElementById('statReviewedFeedbacks').textContent = data.reviewed;

        // Badge de pendentes
        const badge = document.getElementById('feedbackBadge');
        if (data.pending > 0) {
          badge.textContent = data.pending;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading feedback stats:', error);
      }
    }

    async function loadFeedbacks() {
      try {
        const status = document.getElementById('feedbackFilter').value;
        const url = status
          ? `${API_URL}/admin/feedbacks?status=${status}`
          : `${API_URL}/admin/feedbacks`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        feedbacksData = await response.json();
        const container = document.getElementById('feedbacksList');

        if (feedbacksData.length === 0) {
          container.innerHTML = '<div class="loading">Nenhum feedback encontrado</div>';
          return;
        }

        const typeColors = {
          'not_christian': '#dc2626',
          'wrong_info': '#f59e0b',
          'not_helpful': '#6b7280',
          'inappropriate': '#dc2626',
          'other': '#3b82f6'
        };

        const typeIcons = {
          'not_christian': '‚úùÔ∏è',
          'wrong_info': '‚ùå',
          'not_helpful': 'üòï',
          'inappropriate': '‚ö†Ô∏è',
          'other': 'üí¨'
        };

        container.innerHTML = feedbacksData.map(fb => `
          <div style="padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;"
               onclick="showFeedbackDetail('${fb.id}')"
               onmouseover="this.style.borderColor='var(--gold)'"
               onmouseout="this.style.borderColor='var(--border)'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 18px;">${typeIcons[fb.feedback_type] || 'üìù'}</span>
                <span style="background: ${typeColors[fb.feedback_type] || '#6b7280'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                  ${fb.feedback_label}
                </span>
                <span style="color: var(--text-secondary); font-size: 12px;">${fb.user_email}</span>
              </div>
              <span style="font-size: 12px; color: ${fb.status === 'pending' ? 'var(--red)' : '#10b981'};">
                ${fb.status === 'pending' ? 'Pendente' : 'Revisado'}
              </span>
            </div>
            <div style="color: var(--text-primary); font-size: 14px; margin-bottom: 8px;">
              "${fb.message_content}"
            </div>
            ${fb.details ? `<div style="color: var(--text-secondary); font-size: 13px; font-style: italic;">Obs: ${fb.details}</div>` : ''}
            <div style="color: var(--text-muted); font-size: 11px; margin-top: 8px;">
              ${new Date(fb.created_at).toLocaleString('pt-BR')}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading feedbacks:', error);
      }
    }

    function showFeedbackDetail(id) {
      currentFeedbackId = id;
      const fb = feedbacksData.find(f => f.id === id);
      if (!fb) return;

      const typeLabels = {
        'not_christian': { label: 'Nao esta de acordo com a fe crista', icon: '‚úùÔ∏è', color: '#dc2626' },
        'wrong_info': { label: 'Informacao incorreta', icon: '‚ùå', color: '#f59e0b' },
        'not_helpful': { label: 'Nao foi util', icon: 'üòï', color: '#6b7280' },
        'inappropriate': { label: 'Conteudo inapropriado', icon: '‚ö†Ô∏è', color: '#dc2626' },
        'other': { label: 'Outro problema', icon: 'üí¨', color: '#3b82f6' }
      };

      const typeInfo = typeLabels[fb.feedback_type] || { label: fb.feedback_type, icon: 'üìù', color: '#6b7280' };

      document.getElementById('feedbackDetailContent').innerHTML = `
        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <span style="font-size: 24px;">${typeInfo.icon}</span>
            <span style="background: ${typeInfo.color}; color: white; padding: 4px 12px; border-radius: 6px; font-weight: 500;">
              ${typeInfo.label}
            </span>
          </div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
            Reportado por: <strong>${fb.user_email}</strong>
          </div>
          <div style="font-size: 12px; color: var(--text-muted);">
            ${new Date(fb.created_at).toLocaleString('pt-BR')}
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="font-size: 13px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">
            Resposta da IA reportada:
          </label>
          <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.6; max-height: 200px; overflow-y: auto;">
            ${fb.message_full || fb.message_content}
          </div>
        </div>

        ${fb.details ? `
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">
              Observacoes do usuario:
            </label>
            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; font-size: 14px; color: #92400e;">
              ${fb.details}
            </div>
          </div>
        ` : ''}

        <div style="font-size: 13px; color: ${fb.status === 'pending' ? 'var(--red)' : '#10b981'}; font-weight: 500;">
          Status: ${fb.status === 'pending' ? 'Pendente de revisao' : 'Revisado'}
          ${fb.reviewed_at ? ` em ${new Date(fb.reviewed_at).toLocaleString('pt-BR')}` : ''}
        </div>
      `;

      // Esconder bot√£o se j√° foi revisado
      document.getElementById('markReviewedBtn').style.display = fb.status === 'reviewed' ? 'none' : 'block';

      document.getElementById('feedbackDetailModal').classList.add('show');
    }

    function closeFeedbackDetail() {
      document.getElementById('feedbackDetailModal').classList.remove('show');
      currentFeedbackId = null;
    }

    async function markFeedbackReviewed() {
      if (!currentFeedbackId) return;

      try {
        const response = await fetch(`${API_URL}/admin/feedbacks/${currentFeedbackId}/review`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          closeFeedbackDetail();
          loadFeedbacks();
          loadFeedbackStats();
          alert('Feedback marcado como revisado!');
        } else {
          alert('Erro ao marcar feedback');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao marcar feedback');
      }
    }

    // ============================================
    // NOTIFICATIONS FUNCTIONS
    // ============================================

    async function loadNotificationStats() {
      try {
        const response = await fetch(`${API_URL}/notifications/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('statTotalNotifications').textContent = data.total_notifications;
          document.getElementById('statDeliveries').textContent = data.total_deliveries;
          document.getElementById('statPushRegistered').textContent = data.users_push_registered;
          document.getElementById('statEmailEnabled').textContent = data.users_email_enabled;
        }
      } catch (error) {
        console.error('Erro ao carregar stats de notifica√ß√µes:', error);
      }
    }

    async function loadNotificationHistory() {
      try {
        const response = await fetch(`${API_URL}/notifications/list?limit=20`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const notifications = await response.json();
          const container = document.getElementById('notificationHistory');

          if (notifications.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Nenhuma notifica√ß√£o enviada ainda.</p>';
            return;
          }

          container.innerHTML = `
            <table style="width: 100%;">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>T√≠tulo</th>
                  <th>Push</th>
                  <th>Email</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${notifications.map(n => `
                  <tr>
                    <td>${new Date(n.created_at).toLocaleDateString('pt-BR')} ${new Date(n.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</td>
                    <td><strong>${n.title}</strong></td>
                    <td>
                      ${n.send_push ?
                        `<span style="color: var(--green);">${n.push_sent || 0}</span>` +
                        (n.push_failed > 0 ? ` <span style="color: var(--red);">(${n.push_failed} falhas)</span>` : '')
                        : '<span style="color: var(--text-secondary);">-</span>'}
                    </td>
                    <td>
                      ${n.send_email ?
                        `<span style="color: var(--green);">${n.email_sent || 0}</span>` +
                        (n.email_failed > 0 ? ` <span style="color: var(--red);">(${n.email_failed} falhas)</span>` : '')
                        : '<span style="color: var(--text-secondary);">-</span>'}
                    </td>
                    <td>
                      ${n.status === 'sent' ? '<span style="color: var(--green);">‚úì Enviado</span>' :
                        n.status === 'sending' ? '<span style="color: var(--gold);">‚è≥ Enviando...</span>' :
                        n.status === 'pending' ? '<span style="color: var(--text-secondary);">Pendente</span>' : n.status}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        document.getElementById('notificationHistory').innerHTML = '<p style="color: var(--red); text-align: center;">Erro ao carregar hist√≥rico</p>';
      }
    }

    async function updateRecipientPreview() {
      const target = document.getElementById('targetAudience').value;
      const previewEl = document.getElementById('previewText');

      try {
        const response = await fetch(`${API_URL}/notifications/users-preview?target_audience=${target}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          // Montar texto mais claro
          let parts = [];
          parts.push(`<strong>${data.total_users}</strong> usu√°rios no total`);

          if (data.push_registered > 0) {
            parts.push(`<span style="color: #059669;"><strong>${data.push_registered}</strong> v√£o receber Push</span>`);
          } else {
            parts.push(`<span style="color: #dc2626;">0 Push (ningu√©m registrou ainda)</span>`);
          }

          parts.push(`<span style="color: #059669;"><strong>${data.email_enabled}</strong> v√£o receber Email</span>`);

          previewEl.innerHTML = parts.join(' ‚Ä¢ ');
        } else {
          previewEl.textContent = 'Erro ao carregar - tente atualizar a p√°gina';
        }
      } catch (error) {
        console.error('Erro ao carregar preview:', error);
        previewEl.textContent = 'Erro de conex√£o';
      }
    }

    async function sendNotification() {
      const title = document.getElementById('notifTitle').value.trim();
      const message = document.getElementById('notifMessage').value.trim();
      const sendPush = document.getElementById('sendPush').checked;
      const sendEmail = document.getElementById('sendEmail').checked;
      const targetAudience = document.getElementById('targetAudience').value;

      if (!title || !message) {
        alert('Preencha o t√≠tulo e a mensagem');
        return;
      }

      if (!sendPush && !sendEmail) {
        alert('Selecione pelo menos um tipo de envio (Push ou Email)');
        return;
      }

      if (!confirm(`Enviar notifica√ß√£o para ${targetAudience === 'all' ? 'TODOS os usu√°rios' : targetAudience === 'premium' ? 'usu√°rios PREMIUM' : 'usu√°rios GRATUITOS'}?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/notifications/send`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title,
            message,
            send_push: sendPush,
            send_email: sendEmail,
            target_audience: targetAudience
          })
        });

        if (response.ok) {
          const data = await response.json();
          alert(`Notifica√ß√£o sendo enviada para ${data.total_recipients} usu√°rios!`);
          clearNotificationForm();
          loadNotificationStats();
          loadNotificationHistory();
        } else {
          const error = await response.json();
          alert('Erro: ' + (error.detail || 'Erro ao enviar notifica√ß√£o'));
        }
      } catch (error) {
        console.error('Erro ao enviar:', error);
        alert('Erro de conex√£o ao enviar notifica√ß√£o');
      }
    }

    function clearNotificationForm() {
      document.getElementById('notifTitle').value = '';
      document.getElementById('notifMessage').value = '';
      document.getElementById('sendPush').checked = true;
      document.getElementById('sendEmail').checked = true;
      document.getElementById('targetAudience').value = 'all';
      updateRecipientPreview();
    }
  </script>
</body>
</html>
